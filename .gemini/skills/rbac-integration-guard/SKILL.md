---
name: rbac-integration-guard
description: RBAC æƒé™é›†æˆä¸ SQL è‡ªåŠ¨åŒ–å®ˆå«ã€‚å½“æ–°å¢åŠŸèƒ½ã€API æˆ–é¡µé¢æ—¶ä½¿ç”¨ã€‚å¼ºåˆ¶æ‰§è¡Œæƒé™è‡ªåŠ¨æ³¨å†Œã€HQ è§’è‰²è‡ªåŠ¨æˆæƒåŠ SQL è„šæœ¬è‡ªåŠ¨æ‰§è¡Œ/åŒæ­¥ã€‚
---

# RBAC Integration Guard

## æ ¸å¿ƒåŸåˆ™

åœ¨ Smart-CS Pro ä¸­ï¼Œä»»ä½•åŠŸèƒ½ï¼ˆAPIã€UIã€åŠ¨ä½œï¼‰å¿…é¡»å®ç°â€œå¼€å‘å³æˆæƒâ€ã€‚

### 1. æƒé™è‡ªåŠ¨åŒæ­¥çº¢çº¿ (å¼ºåˆ¶)
*   **å¼€å‘å³æ³¨å†Œ**ï¼šæ¯å½“æ–°å¢ä¸€ä¸ªæ¶‰åŠæƒé™çš„åŠŸèƒ½ï¼ˆé¡µé¢è·¯ç”±ã€å¹²é¢„åŠ¨ä½œã€æ•æ„Ÿ APIï¼‰æ—¶ï¼Œå¿…é¡»ç«‹å³ç”Ÿæˆå¯¹åº”çš„ `INSERT INTO permissions` è¯­å¥ã€‚
*   **æ€»éƒ¨è§’è‰² (HQ) ç‰¹æƒè‡ªåŠ¨ç»´æŒ**ï¼šåœ¨æ–°å¢ä»»ä½•æƒé™ç‚¹åï¼Œ**å¿…é¡»åŒæ­¥ç”Ÿæˆå¹¶æ‰§è¡Œ**ä»¥ä¸‹è¯­å¥ï¼š
    ```sql
    -- ç¡®ä¿ HQ è§’è‰² (ID: 3) æ°¸è¿œæ‹¥æœ‰å…¨é‡æƒé™
    INSERT IGNORE INTO role_permissions (role_id, permission_code) 
    SELECT 3, 'æ–°å¢çš„æƒé™ä»£ç ';
    ```
*   **è„šæœ¬å›ºåŒ–**ï¼šæ‰€æœ‰å˜æ›´å¿…é¡»åŒæ­¥è¿½åŠ åˆ° `SmartCS_Desktop/smart-cs-pro/core_engine/database/central_production.sql`ã€‚

### 2. SQL è‡ªåŠ¨åŒ–æ‰§è¡Œå·¥ä½œæµ
*   **çƒ­æ›´æ–°**ï¼šå®Œæˆ SQL ç¼–å†™åï¼Œä¼˜å…ˆå°è¯•ä½¿ç”¨ `run_shell_command` é€šè¿‡ `mysql` å‘½ä»¤è¡Œç›´æ¥æ‰§è¡Œè¯¥ SQL ç‰‡æ®µã€‚
*   **é‡ç½®ç­–ç•¥**ï¼šå¦‚æœæ¶æ„å˜æ›´è¿‡äºå¤æ‚å¯¼è‡´æ‰§è¡Œå¤±è´¥ï¼Œåœ¨å¾å¾—ç”¨æˆ·åŒæ„æˆ–ä¸ºäº†ä¿æŒç¯å¢ƒä¸€è‡´æ€§çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥æ‰§è¡Œ `DROP DATABASE` å¹¶é‡æ–°è¿è¡Œå…¨é‡ `central_production.sql`ã€‚

## æ“ä½œæŒ‡å—

### åœºæ™¯ Aï¼šæ–°å¢åŠŸèƒ½ç‚¹ï¼ˆä»¥æ–°å¢â€œå®æ—¶å½•éŸ³ååŠ©â€ä¸ºä¾‹ï¼‰
1.  **æ ‡è¯†å®šä¹‰**ï¼šç¡®å®šä»£ç ä¸º `command:voice:assist`ã€‚
2.  **ç”Ÿæˆ DDL/DML**ï¼š
    *   `INSERT INTO permissions (code, name, module) VALUES ('command:voice:assist', 'å®æ—¶å½•éŸ³ååŠ©', 'å®æ—¶æŒ‡æŒ¥');`
    *   `INSERT INTO role_permissions (role_id, permission_code) VALUES (3, 'command:voice:assist');`
3.  **è‡ªåŠ¨æ‰§è¡Œ**ï¼š
    *   è¯»å– `.env` ä¸­çš„ DB é…ç½®ã€‚
    *   è°ƒç”¨ `run_shell_command` æ‰§è¡Œ SQLã€‚
4.  **åŒæ­¥ä¸»è„šæœ¬**ï¼šå°†ä¸Šè¿°è¯­å¥è¿½åŠ è‡³ `central_production.sql`ã€‚

### åœºæ™¯ Bï¼šAPI æƒé™æ ¡éªŒ
*   åœ¨ API é€»è¾‘ä¸­ï¼Œå¿…é¡»å¼ºåˆ¶æ ¡éªŒ `current_user["role_id"]` æˆ–æ£€æŸ¥ `role_permissions` å…³è”ã€‚

## ç¤ºä¾‹ (è‡ªåŠ¨åŒ–åé¦ˆ)

> ğŸš€ **æˆ˜æœ¯åŠŸèƒ½å·²åŒæ­¥ï¼š**
> 
> æˆ‘å·²ä¸ºæ‚¨æ–°å¢äº†â€œXXåŠŸèƒ½â€ï¼Œå¹¶æ‰§è¡Œäº†ä»¥ä¸‹è‡ªåŠ¨åŒ–å®ˆå«åŠ¨ä½œï¼š
> 1. åœ¨ `permissions` è¡¨ä¸­æ³¨å†Œäº†æƒé™ç‚¹ã€‚
> 2. **è‡ªåŠ¨ä¸ºæ€»éƒ¨èº«ä»½ï¼ˆHQï¼‰èµ‹äºˆäº†è¯¥åŠŸèƒ½çš„å…¨é‡è®¿é—®æƒã€‚**
> 3. å·²é€šè¿‡å‘½ä»¤è¡Œè‡ªåŠ¨åœ¨ MySQL ä¸­æ‰§è¡Œäº†åŒæ­¥ DDLã€‚
> 4. å˜æ›´å·²å›ºåŒ–è‡³ `central_production.sql`ã€‚
