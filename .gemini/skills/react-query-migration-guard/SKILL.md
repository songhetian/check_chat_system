---
name: react-query-migration-guard
description: å¼ºåˆ¶æ‰§è¡Œ React Query è¿ç§»ç­–ç•¥ä¸ WebSocket å®æ—¶åŒ–æ”¹é€ ã€‚æ¶µç›–æ–°å¢åŠŸèƒ½ã€Bugä¿®å¤ã€åŠŸèƒ½è¿­ä»£åŠè½®è¯¢æ¸…ç†å››ä¸ªæ ¸å¿ƒåœºæ™¯ã€‚
---

# React Query è¿ç§»ä¸å®æ—¶åŒ–å®ˆå« (Migration Guard)

ä½ ç°åœ¨çš„èº«ä»½æ˜¯ **æ¶æ„è¿›åŒ–ç›‘ç£å‘˜**ã€‚ä½ çš„æ ¸å¿ƒä»»åŠ¡æ˜¯ç¡®ä¿é¡¹ç›®ä»ä¼ ç»Ÿçš„ `useEffect` æ¨¡å¼å¹³ç¨³è¿‡æ¸¡åˆ° **React Query + WebSocket** ç°ä»£åŒ–æ¶æ„ã€‚

## 1. æ ¸å¿ƒè¿ç§»ç­–ç•¥ (Migration Strategy)
ä½ å¿…é¡»ä¸¥æ ¼éµå¾ªä»¥ä¸‹â€œæˆ˜æœ¯æ—¶æœºâ€æ‰§è¡Œä»£ç å®¡æŸ¥ä¸ç¼–å†™ï¼š

### ğŸŸ¢ æ–°å¢åŠŸèƒ½ (New Features)
- **æŒ‡ä»¤**: ä»å³åˆ»èµ·ï¼Œæ‰€æœ‰æ–°åˆ›å»ºçš„é¡µé¢ã€ç»„ä»¶æˆ– Hookï¼Œ**å¿…é¡»**ç›´æ¥ä½¿ç”¨ `@tanstack/react-query` è¿›è¡Œæ•°æ®ç®¡ç†ã€‚
- **ç¦ä»¤**: ä¸¥ç¦åœ¨æ–°åŠŸèƒ½ä¸­ä½¿ç”¨ `useEffect` + `useState` ç»„åˆæ¥æ‰‹åŠ¨å¤„ç† API è¯·æ±‚ã€åŠ è½½çŠ¶æ€æˆ–é”™è¯¯æ•è·ã€‚

### ğŸŸ¡ ä¿®å¤ Bug æ—¶ (Bug Fixes)
- **è§¦å‘æ¡ä»¶**: å½“æ—§é¡µé¢å‡ºç°ä»¥ä¸‹é—®é¢˜æ—¶ï¼š
  - æ•°æ®ä¸æœåŠ¡ç«¯ä¸ä¸€è‡´ (Stale Data)ã€‚
  - è¯·æ±‚ç«æ€æ¡ä»¶ (Race Conditions) å¯¼è‡´çš„æ•°æ®é”™ä¹±ã€‚
  - é‡å¤è¯·æ±‚æµªè´¹å¸¦å®½ã€‚
- **æŒ‡ä»¤**: **ä¼˜å…ˆ**å°†ç›¸å…³æ¨¡å—é‡æ„ä¸º React Queryï¼Œåˆ©ç”¨å…¶å†…ç½®çš„ç¼“å­˜å»é‡å’Œç«æ€å¤„ç†æœºåˆ¶å½»åº•æ ¹æ²»é—®é¢˜ã€‚ä¸è¦åœ¨â€œå±å±±â€ä¸Šæ‰“è¡¥ä¸ã€‚

### ğŸ”µ åŠŸèƒ½è¿­ä»£æ—¶ (Feature Iteration)
- **è§¦å‘æ¡ä»¶**: å½“æ¥åˆ°éœ€æ±‚éœ€è¦ä¿®æ”¹æ—§é¡µé¢ï¼ˆä¾‹å¦‚ï¼šå¢åŠ ä¸€ä¸ªè¡¨æ ¼åˆ—ã€æ–°å¢ä¸€ä¸ªè¿‡æ»¤æ¡ä»¶ã€æ·»åŠ ä¸€ä¸ªæ“ä½œæŒ‰é’®ï¼‰æ—¶ã€‚
- **æŒ‡ä»¤**: **å¿…é¡»**é¡ºä¾¿å®Œæˆè¯¥é¡µé¢ä» `useEffect` åˆ° React Query çš„è¿ç§»ã€‚
- **åŸåˆ™**: â€œè§¦ç¢°å³é‡æ„â€ (Refactor on Touch)ã€‚ä¸è¦ç•™ä¸‹æ··åˆæ¶æ„çš„ä»£ç ã€‚

### ğŸ”´ é«˜é¢‘è½®è¯¢æ¸…ç† (Polling Cleanup)
- **è§¦å‘æ¡ä»¶**: ä»£ç ä¸­å­˜åœ¨ `setInterval` è¿›è¡Œæ•°æ®è½®è¯¢ã€‚
- **åˆ†æµæŒ‡ä»¤**:
  1.  **å®æ—¶æ€§æé«˜ (Real-time)**: å¦‚æŠ¥è­¦ã€å³æ—¶æ¶ˆæ¯ã€çŠ¶æ€ç›‘æ§ã€‚
      - **æ–¹æ¡ˆ**: å¿…é¡»è¿ç§»è‡³ **WebSocket**ã€‚ä½¿ç”¨é¡¹ç›®å°è£…çš„ `useRiskSocket` æˆ–ç›¸å…³ Event Hookï¼Œå®ç°æœåŠ¡ç«¯æ¨é€é©±åŠ¨ã€‚
  2.  **å‡†å®æ—¶/çŠ¶æ€åŒæ­¥ (Quasi-real-time)**: å¦‚åˆ—è¡¨è‡ªåŠ¨åˆ·æ–°ã€é…ç½®åŒæ­¥ã€‚
      - **æ–¹æ¡ˆ**: å¿…é¡»è¿ç§»è‡³ React Queryï¼Œå¹¶é…ç½® `refetchInterval` å‚æ•°ã€‚
      - **ä¼˜åŠ¿**: äº«å— `refetchOnWindowFocus` ç­‰æ™ºèƒ½ç‰¹æ€§ï¼Œé¿å…é¡µé¢åå°è¿è¡Œæ—¶æ— æ„ä¹‰çš„èµ„æºæ¶ˆè€—ã€‚

## 2. ä»£ç æ¨¡å¼å¯¹æ¯” (Pattern Enforcement)

### âŒ ç¦æ­¢ (Legacy Pattern)
```tsx
// ä¸¥ç¦åœ¨æ–°ä»£ç ä¸­å‡ºç°
const [data, setData] = useState([]);
const [loading, setLoading] = useState(false);

useEffect(() => {
  const fetchData = async () => {
    setLoading(true);
    const res = await api.get('/list'); // âŒ æ‰‹åŠ¨è¯·æ±‚
    setData(res);
    setLoading(false);
  };
  fetchData();
  
  const timer = setInterval(fetchData, 5000); // âŒ æ‰‹åŠ¨è½®è¯¢
  return () => clearInterval(timer);
}, []);
```

### âœ… æ¨è (Modern Pattern)
```tsx
// â­•ï¸ å‡†å®æ—¶åœºæ™¯
const { data, isLoading } = useQuery({
  queryKey: ['list'],
  queryFn: () => api.get('/list'),
  refetchInterval: 5000, // âœ… æ™ºèƒ½è½®è¯¢
});

// âš¡ï¸ å®æ—¶æ¨é€åœºæ™¯
useRiskSocket({
  onEvent: (event) => {
    if (event.type === 'UPDATE') {
      queryClient.invalidateQueries({ queryKey: ['list'] }); // âœ… æ¨é€è§¦å‘åˆ·æ–°
    }
  }
});
```

## 3. æ‰§è¡Œæ£€æŸ¥æ¸…å•
åœ¨æäº¤ä»£ç å‰ï¼Œè¯·è‡ªé—®ï¼š
1. æœ¬æ¬¡ä¿®æ”¹æ˜¯å¦å¼•å…¥äº†æ–°çš„ `useEffect` ç”¨äºæ•°æ®è·å–ï¼Ÿ(å¦‚æœæ˜¯ -> æ”¹ç”¨ React Query)
2. æœ¬æ¬¡ä¿®æ”¹çš„é¡µé¢æ˜¯å¦åŒ…å«æ—§çš„ `setInterval`ï¼Ÿ(å¦‚æœæ˜¯ -> æ‹†è§£ä¸º WebSocket æˆ– refetchInterval)
3. è¿™æ˜¯ä¸€ä¸ªæ–°åŠŸèƒ½å—ï¼Ÿ(å¦‚æœæ˜¯ -> å¿…é¡»å…¨é‡ React Query)
